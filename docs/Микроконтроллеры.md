# Микроконтроллеры

Чипы с поддержкой Bluetooth LE (BLE) являются мощными микроконтроллерами (например, CC2541 или TLSR8266), однако их программирование требует специальных знаний, навыков и ПО.
Для упрощения задачи прототипирования мы будет использовать более простые и удобные микроконтроллеры, использующие BLE-модули для приема/передачи данных через UART-интерфейс.

Для программирования микроконтроллеров вам потребуется бесплатная среда разработки [Ardunio IDE](https://www.arduino.cc/en/Main/Software).

Для продолжительной работы конечных устройств необходимо снизить энергопотребление микроконтроллера, путем перевода его в режим с пониженным энергопотреблением (режим сна).
Чаще всего используются два режима сна:

* Сон с пробуждением по таймеру. В этом случае микроконтроллер просыпается с заданным интервалом (от 100 мс до 8 сек), выполняет нужную работу и засыпает опять. Такой режим очень удобен для снятия и передачи показаний датчиков.
* Сон с пробуждением по изменению логического уровня на пине. В этом случае микроконтроллер просыпается только тогда, когда на заданном пине низкий уровень меняется на высокий (raising) или высокий на низкий (falling). Такой режим удобен, когда отслеживается внешнее событие.

# Arduino Pro Mini

|Плюсы|Минусы|Напряжение|Потребление в режиме сна|Цена, руб.|
| :----------- |:----------- |:----------- |:----------- |:----------- |
|Компактный размер, при наличии достаточно большого числа пинов ADC, IO, PWM, I2C. Хорошо подходит для работы с несколькими датчикам или со сложными датчиками. Приличный объем памяти. Программируется из Arduino IDE.|Отсутствует USB-разъем для подключения к ПК, нужен UBS-RS232 конвертер.|5В или 3В|~100 мкА|130|

Вы можете купить плату на 5В или плату на 3В. Плата на 5В также работает и при напряжении 3В.

[Распиновка](http://www.pighixxx.com/test/portfolio-items/pro-mini-new-version/?portfolioID=314)

### Режим сна

Используйте библиотеку [Low-Power](https://github.com/rocketscream/Low-Power) для удобного перевода в режим с пониженным энергопотреблением. 
Скачайте ее с GitHub как zip-архив, затем в Arduino IDE выберите пункт Sketch - Install library и импортируйте скачанный zip-архив.
Теперь погружение контроллера в сон выполняется одной командой:

```
#include <LowPower.h>

void loop() 
{
  // используем режим Watchdog Timer с пробуждением каждые 8 сек., выключаем ADC и BOD
  LowPower.powerDown(SLEEP_8S, ADC_OFF, BOD_OFF);
  
  // здесь выполняем работу после пробуждения
  ...
}
```

Чтобы добиться действительно хороших показателей по энергопотреблению в режиме сна, потребуется удалить с платы несколько элементов:

* Power LED, который светится при наличии напряжения на плате
* Стабилизатор напряжения, расположенный рядом с пинами RX/TX

Подробнее об этом описано в [этой статье](https://andreasrohner.at/posts/Electronics/How-to-modify-an-Arduino-Pro-Mini-clone-for-low-power-consumption/).
Также лучше не использовать пин 13, поскольку на нем также висит светодиод.

### Программирование

Для подключения микроконтроллера к ПК используйте готовый кабель USB-RS232 (TTL) или его эмуляцию на плате Arduino, собранную по следующей схеме:

